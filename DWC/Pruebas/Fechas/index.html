<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="ISO-8859-1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <input type="date" onchange="PonerFechaMinima(this.value)">
    <input type="date" onchange="PonerFechaMaxima(this.value)">
    <button onclick="MirarFechas()">Insertar fechas</button>
    <canvas id="grafico"></canvas>
    <script>
        let humedades = new Array()
        let temperaturas = new Array()
        let inputs = document.querySelectorAll('input')
        let fecha = new Date()
        let dias = new Array()
        inputs[1].max = fecha.toISOString().split('T')[0]
        fecha.setDate(fecha.getDate() - 1)
        inputs[0].max = fecha.toISOString().split('T')[0]
        fecha.setFullYear(fecha.getFullYear() - 3)
        fecha.setMonth(fecha.getMonth() - 1)
        inputs[0].min = fecha.toISOString().split('T')[0]
        inputs[1].min = fecha.toISOString().split('T')[0]
        let fechaActual = new Date()
        let graf = new Chart("grafico", {
            type: 'line',
            data: {
                labels: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                datasets: [{
                    label: 'Temperatura',
                    data: [],
                    borderWidth: 1
                }, {
                    label: 'Humedad',
                    data: [],
                    borderWidth: 1
                }]
            },

            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        fechaActual.setMonth(fechaActual.getMonth() - 12)
        const options = {
            method: 'GET',
            headers: {
                Authorization: 'Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJtZXQwMS5hcGlrZXkiLCJpc3MiOiJJRVMgUExBSUFVTkRJIEJISSBJUlVOIiwiZXhwIjoyMjM4MTMxMDAyLCJ2ZXJzaW9uIjoiMS4wLjAiLCJpYXQiOjE2Mzk3NDc5MDcsImVtYWlsIjoiaWtjZXVAcGxhaWF1bmRpLm5ldCJ9.WmgNDEzi60hZ9lzj0lkmLEVgUdJN8Mw24kJacq2u9BMuhaycjTKqerRp9QmnVbez3iyqmsABu93rNPeFAuKvPIohyRBe2a1j4iclFT7Ro5slaBlhsTWiaB874mKCMbX2JSNYu_IqArqEcVblHxfZEtdT2jo1aw63-KGpggSzyYpAUeM32WGsUGs34L1CF55bwmj3risa8KMp9BfB4cOykcP4qX-lE2P2MiL0ea2lhUTWtAv943JhsHNTYKBwXU56otJwHMKPwCVL3_CwhLgYcoyFtLGKx9zFm2wTmJqegFJWtZ2CSoRBoXkefsq9atjTZ2OfSd4pPolRVo2dlCLY8g'
            }
        }
        function MirarFechas() {
            let inputSeparado = new Array()
            for (let input of inputs) {
                inputSeparado.push(input.value)
            }
            let fecha = new Date()
            let fechaDeseada = new Date()
            fecha.setTime(Date.parse(inputSeparado[0]))
            fechaDeseada.setTime(Date.parse(inputSeparado[1]))
            let fechaSeparada = fecha.toISOString().split('T')[0].split("-")
            let fechaDeseadaSeparada = fechaDeseada.toISOString().split('T')[0].split("-")
            while ((fechaSeparada[0] != fechaDeseadaSeparada[0]) || (fechaSeparada[1] != fechaDeseadaSeparada[1]) || (fechaSeparada[2] != fechaDeseadaSeparada[2])) {
                fechaSeparada = fecha.toISOString().split('T')[0].split("-")
                RellenarDatos(fechaSeparada, fechaDeseadaSeparada)
                dias.push(fecha.toISOString().split('T')[0])
                fecha.setDate(fecha.getDate() + 1)
            }
        }

        function PonerFechaMinima(fecha) {
            inputs[1].min = fecha
        }

        function PonerFechaMaxima(fecha) {
            let date = new Date(fecha)
            date.setDate(date.getDate() - 1);
            inputs[0].max = date.toISOString().split('T')[0]
        }


        function RellenarDatos(fechaSeparada, fechaDeseadaSeparada) {
            fetch(`https://api.euskadi.eus/euskalmet/weather/regions/basque_country/zones/great_bilbao/locations/barakaldo/reports/for/${fechaSeparada[0]}/${fechaSeparada[1]}/${fechaSeparada[2]}/last`, options)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("La solicitud no se pudo completar correctamente.");
                    }
                    return response.json();
                })
                .then(data => {
                    temperaturas.push(data.report.temperature.value)
                    humedades.push(data.report.humidity.value)

                    if (fechaSeparada[0] == fechaDeseadaSeparada[0] && fechaSeparada[1] == fechaDeseadaSeparada[1] && fechaSeparada[2] == fechaDeseadaSeparada[2]) {
                        graf.data.datasets[0].data = temperaturas
                        graf.data.datasets[1].data = humedades
                        graf.data.labels = dias
                        graf.update()
                        temperaturas = []
                        humedades = []
                        dias = []
                    }
                })
        }
    </script>
</body>

</html>